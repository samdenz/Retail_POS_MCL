<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profile | Retail POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/pos.css">
</head>

<body>
<div class="dashboard-container">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Retail POS</h2>
        </div>

        <nav>
            <div id="sidebar-links"></div>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <h1>My Profile</h1>

        <section class="profile-section">
            <h2>Personal Information</h2>
            <div id="personal-info"></div>
        </section>

        <section class="profile-section">
            <h2>Change Password</h2>
            <div id="change-password"></div>
        </section>

        <section class="profile-section">
            <h2>Recent Activity</h2>
            <div id="activity-history"></div>
        </section>
    </main>

</div>

<script>
/* =========================
   GLOBAL USER + AUTH CHECK
========================= */

const user = JSON.parse(localStorage.getItem('pos_user'));
const token = localStorage.getItem('pos_token');

if (!user || !token) {
    window.location.href = 'login.html';
}

/* =========================
   SIDEBAR ROLE LINKS
========================= */

function loadSidebar() {
    const sidebarLinks = document.getElementById('sidebar-links');

    if (user.role.toLowerCase() === 'admin') {
        sidebarLinks.innerHTML = `
            <a href="admin-dashboard.html">Dashboard</a>
            <a href="admin-inventory.html">Inventory</a>
            <a href="admin-reports.html">Reports</a>
            <a href="admin-users.html">Users</a>
            <a href="profile.html" class="active">Profile</a>
        `;
    } else {
        sidebarLinks.innerHTML = `
            <a href="pos.html">POS</a>
            <a href="cashier-history.html">My Sales</a>
            <a href="profile.html" class="active">Profile</a>
        `;
    }
}

/* =========================
   LOGOUT
========================= */

document.getElementById('logout-btn').addEventListener('click', () => {
    localStorage.removeItem('pos_user');
    localStorage.removeItem('pos_token');
    window.location.href = 'login.html';
});

/* =========================
   HELPER
========================= */

function getAuthHeaders() {
    return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    };
}

/* =========================
   LOAD PERSONAL INFO
========================= */

function loadProfileInfo() {
    const infoDiv = document.getElementById('personal-info');

    infoDiv.innerHTML = `
        <div class="card profile-card">
            <p><strong>Username:</strong> ${user.username}</p>
            <p><strong>Role:</strong> <span class="badge">${user.role}</span></p>
            <p><strong>Full Name:</strong> ${user.full_name || 'N/A'}</p>
        </div>
    `;
}

/* =========================
   CHANGE PASSWORD
========================= */

function setupChangePassword() {
    const container = document.getElementById('change-password');

    container.innerHTML = `
        <form id="change-pwd-form" class="card form-card">
            <label>Current Password</label>
            <input type="password" id="currentPwd" required>

            <label>New Password</label>
            <input type="password" id="newPwd" required>

            <label>Confirm New Password</label>
            <input type="password" id="confirmPwd" required>

            <div id="pwdError" class="error-msg"></div>

            <button type="submit" class="primary-btn">Change Password</button>
        </form>
    `;

    document.getElementById('change-pwd-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const current = currentPwd.value;
        const newPwd = newPwd.value;
        const confirm = confirmPwd.value;
        const errorDiv = document.getElementById('pwdError');

        errorDiv.textContent = "";

        if (newPwd.length < 6) {
            errorDiv.textContent = "Password must be at least 6 characters.";
            return;
        }

        if (newPwd !== confirm) {
            errorDiv.textContent = "New passwords do not match.";
            return;
        }

        try {
            const res = await fetch('http://localhost:3000/api/auth/change-password', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    current_password: current,
                    new_password: newPwd
                })
            });

            const data = await res.json();

            if (!res.ok || !data.success) {
                throw new Error(data.message || "Failed to change password");
            }

            alert("Password changed successfully!");
            e.target.reset();

        } catch (err) {
            errorDiv.textContent = err.message;
        }
    });
}

/* =========================
   LOAD ACTIVITY HISTORY
========================= */

async function loadActivityHistory() {
    const historyDiv = document.getElementById('activity-history');

    historyDiv.innerHTML = `
        <div class="card loading-card">
            Loading recent transactions...
        </div>
    `;

    try {
        const res = await fetch('http://localhost:3000/api/sales/my-sales?limit=10', {
            headers: getAuthHeaders()
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
            throw new Error(data.message || "Failed to load history");
        }

        if (!data.sales.length) {
            historyDiv.innerHTML = `<div class="card">No recent activity.</div>`;
            return;
        }

        historyDiv.innerHTML = `
            <div class="card">
                ${data.sales.map(sale => `
                    <div class="activity-item">
                        <div>
                            <strong>${new Date(sale.sale_date).toLocaleString()}</strong>
                        </div>
                        <div>KES ${parseFloat(sale.total_amount).toFixed(2)}</div>
                        <div class="payment-tag">${sale.payment_method}</div>
                    </div>
                `).join('')}
            </div>
        `;

    } catch (err) {
        historyDiv.innerHTML = `
            <div class="card error-msg">
                ${err.message}
            </div>
        `;
    }
}

/* =========================
   INIT
========================= */

loadSidebar();
loadProfileInfo();
setupChangePassword();
loadActivityHistory();

</script>

</body>
</html>
